<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººåšå®¢ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f0f2f5;
            height: 100vh;
            overflow: hidden;
        }

        /* é¡¶éƒ¨æ  */
        .topbar {
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 100;
        }

        .topbar h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            display: flex;
            height: calc(100vh - 50px);
        }

        /* å·¦ä¾§èœå• */
        .sidebar {
            width: 200px;
            background: #001529;
            color: white;
            overflow-y: auto;
        }

        .menu-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .menu-item.active {
            background: #1890ff;
            border-left-color: #40a9ff;
        }

        /* å³ä¾§å†…å®¹åŒº */
        .content-area {
            flex: 1;
            background: #fff;
            margin: 12px;
            border-radius: 4px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            overflow-y: auto;
            padding: 20px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 6px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-block;
        }

        .btn-primary {
            background: #1890ff;
            color: white;
        }

        .btn-primary:hover {
            background: #40a9ff;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #ff4d4f;
            color: white;
        }

        .btn-danger:hover {
            background: #ff7875;
        }

        .btn-success {
            background: #52c41a;
            color: white;
        }

        .btn-small {
            padding: 4px 10px;
            font-size: 12px;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 13px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #40a9ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* æç¤ºæ¡† */
        .alert {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 16px;
            display: none;
            font-size: 13px;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }

        .alert-error {
            background: #fff2f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }

        /* æ–‡ç« å¡ç‰‡ */
        .post-card {
            border: 1px solid #f0f0f0;
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s;
            background: #fafafa;
        }

        .post-card:hover {
            border-color: #1890ff;
            box-shadow: 0 2px 8px rgba(24, 144, 255, 0.15);
        }

        .post-card h3 {
            color: #333;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 15px;
        }

        .post-card h3:hover {
            color: #1890ff;
        }

        .post-meta {
            color: #8c8c8c;
            font-size: 12px;
            margin-bottom: 12px;
        }

        .post-content {
            color: #555;
            line-height: 1.6;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .post-actions {
            display: flex;
            gap: 8px;
        }

        /* è¯„è®ºå¡ç‰‡ */
        .comment-card {
            background: #fafafa;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 12px;
            border-left: 3px solid #1890ff;
        }

        .comment-meta {
            color: #8c8c8c;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .comment-content {
            color: #333;
            line-height: 1.6;
            font-size: 13px;
        }

        /* é¡µé¢æ ‡é¢˜ */
        .page-header {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .page-header h2 {
            font-size: 18px;
            color: #333;
        }

        .back-btn {
            margin-bottom: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8c8c8c;
            font-size: 13px;
        }

        /* é…ç½®åŒºåŸŸ */
        .config-section {
            background: #fafafa;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 16px;
            border: 1px solid #f0f0f0;
        }

        .config-section h3 {
            margin-bottom: 12px;
            color: #333;
            font-size: 15px;
        }

        .test-results {
            margin-top: 16px;
            padding: 12px;
            background: #fafafa;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #f0f0f0;
        }

        .test-item {
            padding: 6px;
            margin-bottom: 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .test-success {
            background: #f6ffed;
            color: #52c41a;
        }

        .test-error {
            background: #fff2f0;
            color: #ff4d4f;
        }

        .hidden {
            display: none;
        }

        /* è¯¦æƒ…é¡µæ ·å¼ */
        .post-detail-header {
            margin-bottom: 20px;
        }

        .post-detail-header h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 10px;
        }

        .comments-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }

        .comments-section h3 {
            font-size: 16px;
            margin-bottom: 16px;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .sidebar {
                width: 160px;
            }

            .topbar h1 {
                font-size: 16px;
            }

            .content-area {
                margin: 8px;
                padding: 12px;
            }
        }
    </style>
</head>

<body>
    <!-- é¡¶éƒ¨æ  -->
    <div class="topbar">
        <h1>ğŸš€ ä¸ªäººåšå®¢ç®¡ç†ç³»ç»Ÿ</h1>
        <div class="user-info">
            <span id="userDisplay"></span>
            <button id="logoutBtn" class="btn btn-secondary btn-small hidden">é€€å‡º</button>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- å·¦ä¾§èœå• -->
        <div class="sidebar">
            <div class="menu-item active" data-page="home">ğŸ“š é¦–é¡µ</div>
            <div class="menu-item" data-page="login">ğŸ” ç™»å½•</div>
            <div class="menu-item" data-page="register">ğŸ“ æ³¨å†Œ</div>
            <div class="menu-item" data-page="myPosts">ğŸ“– æˆ‘çš„æ–‡ç« </div>
            <div class="menu-item" data-page="createPost">âœï¸ å‘å¸ƒæ–‡ç« </div>
            <div class="menu-item" data-page="test">ğŸ§ª APIæµ‹è¯•</div>
        </div>

        <!-- å³ä¾§å†…å®¹åŒº -->
        <div class="content-area">
            <div id="alertBox" class="alert"></div>

            <!-- é¦–é¡µ -->
            <div id="homePage" class="page">
                <div class="page-header">
                    <h2>æœ€æ–°æ–‡ç« </h2>
                </div>
                <div id="postsList"></div>
            </div>

            <!-- ç™»å½•é¡µ -->
            <div id="loginPage" class="page hidden">
                <div class="page-header">
                    <h2>ç”¨æˆ·ç™»å½•</h2>
                </div>
                <form id="loginForm" style="max-width: 400px;">
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="loginUsername" required>
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">ç™»å½•</button>
                </form>
            </div>

            <!-- æ³¨å†Œé¡µ -->
            <div id="registerPage" class="page hidden">
                <div class="page-header">
                    <h2>ç”¨æˆ·æ³¨å†Œ</h2>
                </div>
                <form id="registerForm" style="max-width: 400px;">
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="regUsername" required>
                    </div>
                    <div class="form-group">
                        <label>é‚®ç®±</label>
                        <input type="email" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" id="regPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">æ³¨å†Œ</button>
                </form>
            </div>

            <!-- æˆ‘çš„æ–‡ç«  -->
            <div id="myPostsPage" class="page hidden">
                <div class="page-header">
                    <h2>æˆ‘çš„æ–‡ç« </h2>
                </div>
                <div id="myPostsList"></div>
            </div>

            <!-- å‘å¸ƒæ–‡ç«  -->
            <div id="createPostPage" class="page hidden">
                <div class="page-header">
                    <h2>å‘å¸ƒæ–‡ç« </h2>
                </div>
                <form id="createPostForm" style="max-width: 800px;">
                    <div class="form-group">
                        <label>æ ‡é¢˜</label>
                        <input type="text" id="postTitle" required>
                    </div>
                    <div class="form-group">
                        <label>å†…å®¹</label>
                        <textarea id="postContent" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">å‘å¸ƒ</button>
                </form>
            </div>

            <!-- æ–‡ç« è¯¦æƒ… -->
            <div id="postDetailPage" class="page hidden">
                <button class="btn btn-secondary back-btn" onclick="app.showPage('home')">â† è¿”å›</button>
                <div id="postDetail"></div>
                <div class="comments-section">
                    <h3>ğŸ’¬ è¯„è®ºåŒº</h3>
                    <form id="commentForm" class="hidden" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <textarea id="commentContent" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">å‘è¡¨è¯„è®º</button>
                    </form>
                    <div id="commentsList"></div>
                </div>
            </div>

            <!-- ç¼–è¾‘æ–‡ç«  -->
            <div id="editPostPage" class="page hidden">
                <button class="btn btn-secondary back-btn" onclick="app.showPage('myPosts')">â† è¿”å›</button>
                <div class="page-header">
                    <h2>ç¼–è¾‘æ–‡ç« </h2>
                </div>
                <form id="editPostForm" style="max-width: 800px;">
                    <input type="hidden" id="editPostId">
                    <div class="form-group">
                        <label>æ ‡é¢˜</label>
                        <input type="text" id="editPostTitle" required>
                    </div>
                    <div class="form-group">
                        <label>å†…å®¹</label>
                        <textarea id="editPostContent" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                </form>
            </div>

            <!-- APIæµ‹è¯• -->
            <div id="testPage" class="page hidden">
                <div class="page-header">
                    <h2>APIæµ‹è¯•ä¸­å¿ƒ</h2>
                </div>

                <div class="config-section">
                    <h3>âš™ï¸ é…ç½®</h3>
                    <div class="form-group">
                        <label>API Base URL</label>
                        <input type="text" id="apiBaseUrl" value="http://localhost:8080/api/v1">
                    </div>
                    <button class="btn btn-primary" onclick="app.saveConfig()">ä¿å­˜é…ç½®</button>
                </div>

                <div class="config-section">
                    <h3>ğŸ” æµ‹è¯•é€‰é¡¹</h3>
                    <button class="btn btn-success" onclick="app.runAllTests()">è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
                    <button class="btn btn-primary" onclick="app.testHealth()">å¥åº·æ£€æŸ¥</button>
                    <button class="btn btn-primary" onclick="app.testAuth()">æµ‹è¯•è®¤è¯</button>
                    <button class="btn btn-primary" onclick="app.testPosts()">æµ‹è¯•æ–‡ç« </button>
                    <button class="btn btn-primary" onclick="app.testComments()">æµ‹è¯•è¯„è®º</button>
                    <button class="btn btn-danger" onclick="app.clearTestResults()">æ¸…é™¤ç»“æœ</button>
                </div>

                <div class="test-results" id="testResults">
                    <p style="color: #8c8c8c;">æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        var app = {
            apiBase: 'http://localhost:8080/api/v1',
            token: localStorage.getItem('token') || '',
            user: null,
            currentPost: null,

            init: function () {
                this.loadConfig();
                this.bindEvents();
                if (this.token) {
                    this.fetchProfile();
                }
                this.fetchPosts();
            },

            loadConfig: function () {
                var saved = localStorage.getItem('apiBase');
                if (saved) {
                    this.apiBase = saved;
                    document.getElementById('apiBaseUrl').value = saved;
                }
            },

            saveConfig: function () {
                this.apiBase = document.getElementById('apiBaseUrl').value;
                localStorage.setItem('apiBase', this.apiBase);
                this.showAlert('success', 'é…ç½®å·²ä¿å­˜');
            },

            bindEvents: function () {
                var self = this;

                document.querySelectorAll('.menu-item').forEach(function (item) {
                    item.addEventListener('click', function (e) {
                        var page = e.target.dataset.page;
                        self.showPage(page);
                    });
                });

                document.getElementById('loginForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    self.handleLogin();
                });

                document.getElementById('registerForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    self.handleRegister();
                });

                document.getElementById('createPostForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    self.handleCreatePost();
                });

                document.getElementById('editPostForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    self.handleUpdatePost();
                });

                document.getElementById('commentForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    self.handleCreateComment();
                });

                document.getElementById('logoutBtn').addEventListener('click', function () {
                    self.handleLogout();
                });
            },

            showPage: function (page) {
                var self = this;
                document.querySelectorAll('.page').forEach(function (p) {
                    p.classList.add('hidden');
                });
                document.querySelectorAll('.menu-item').forEach(function (m) {
                    m.classList.remove('active');
                });

                var pageMap = {
                    'home': 'homePage',
                    'login': 'loginPage',
                    'register': 'registerPage',
                    'myPosts': 'myPostsPage',
                    'createPost': 'createPostPage',
                    'test': 'testPage'
                };

                var pageId = pageMap[page];
                if (pageId) {
                    document.getElementById(pageId).classList.remove('hidden');
                    var menuItem = document.querySelector('[data-page="' + page + '"]');
                    if (menuItem) menuItem.classList.add('active');
                }

                if (page === 'myPosts') {
                    this.fetchMyPosts();
                } else if (page === 'home') {
                    this.fetchPosts();
                }
            },

            showAlert: function (type, message) {
                var alert = document.getElementById('alertBox');
                alert.className = 'alert alert-' + type + ' show';
                alert.textContent = message;
                setTimeout(function () {
                    alert.classList.remove('show');
                }, 5000);
            },

            updateUserDisplay: function () {
                var display = document.getElementById('userDisplay');
                var logoutBtn = document.getElementById('logoutBtn');

                if (this.user) {
                    display.textContent = 'ğŸ‘¤ ' + this.user.username;
                    logoutBtn.classList.remove('hidden');
                } else {
                    display.textContent = '';
                    logoutBtn.classList.add('hidden');
                }
            },

            fetchProfile: function () {
                var self = this;
                fetch(this.apiBase + '/profile', {
                    headers: { 'Authorization': 'Bearer ' + this.token }
                })
                    .then(function (res) { return res.json(); })
                    .then(function (data) {
                        if (data.code === 200) {
                            self.user = data.data;
                            self.updateUserDisplay();
                        } else {
                            self.handleLogout();
                        }
                    })
                    .catch(function (err) {
                        console.error('Fetch profile error:', err);
                    });
            },

            handleLogin: function () {
                var self = this;
                var username = document.getElementById('loginUsername').value;
                var password = document.getElementById('loginPassword').value;

                fetch(this.apiBase + '/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, password: password })
                })
                    .then(function (res) { return res.json(); })
                    .then(function (data) {
                        if (data.code === 200) {
                            self.token = data.data.token;
                            localStorage.setItem('token', self.token);
                            self.fetchProfile();
                            self.showAlert('success', 'ç™»å½•æˆåŠŸ!');
                            self.showPage('home');
                            document.getElementById('loginForm').reset();
                        } else {
                            self.showAlert('error', data.message || 'ç™»å½•å¤±è´¥');
                        }
                    })
                    .catch(function (err) {
                        self.showAlert('error', 'ç™»å½•è¯·æ±‚å¤±è´¥');
                    });
            },

            handleRegister: function () {
                var self = this;
                var username = document.getElementById('regUsername').value;
                var email = document.getElementById('regEmail').value;
                var password = document.getElementById('regPassword').value;

                fetch(this.apiBase + '/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username, email: email, password: password })
                })
                    .then(function (res) { return res.json(); })
                    .then(function (data) {
                        if (data.code === 200) {
                            self.showAlert('success', 'æ³¨å†ŒæˆåŠŸ!è¯·ç™»å½•');
                            self.showPage('login');
                            document.getElementById('registerForm').reset();
                        } else {
                            self.showAlert('error', data.message || 'æ³¨å†Œå¤±è´¥');
                        }
                    })
                    .catch(function (err) {
                        self.showAlert('error', 'æ³¨å†Œè¯·æ±‚å¤±è´¥');
                    });
            },

            handleLogout: function () {
                this.token = '';
                this.user = null;
                localStorage.removeItem('token');
                this.updateUserDisplay();
                this.showAlert('success', 'å·²é€€å‡ºç™»å½•');
                this.showPage('home');
            },

            fetchPosts: function () {
                var self = this;
                fetch(this.apiBase + '/posts')
                    .then(function (res) { return res.json(); })
                    .then(function (data) {
                        if (data.code === 200) {
                            self.renderPosts(data.data.posts || [], 'postsList');
                        }
                    })
                    .catch(function (err) {
                        self.showAlert('error', 'è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥');
                    });
            },

            fetchMyPosts: function () {
                var self = this;
                if (!this.token) {
                    this.showAlert('error', 'è¯·å…ˆç™»å½•');
                    return;
                }

                fetch(this.apiBase + '/posts', {
                    headers: { 'Authorization': 'Bearer ' + this.token }
                })
                    .then(function (res) { return res.json(); })
                    .then(function (data) {
                        if (data.code === 200) {
                            var myPosts = (data.data.posts || []).filter(function (post) {
                                return post.user_id === self.user.id;
                            });
                            self.renderPosts(myPosts, 'myPostsList', true);
                        }
                    })
                    .catch(function (err) {
                        self.showAlert('error', 'è·å–æˆ‘çš„æ–‡ç« å¤±è´¥');
                    });
            },

            renderPosts: function (posts, containerId, showActions) {
                var self = this;
                var container = document.getElementById(containerId);

                if (!posts || posts.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div style="font-size: 40px;">ğŸ“­</div><p>æš‚æ— æ–‡ç« </p></div>';
                    return;
                }

                container.innerHTML = posts.map(function (post) {
                    var actions = '';
                    if (showActions && self.user && post.user_id === self.user.id) {
                        actions = '<div class="post-actions">' +
                            '<button class="btn btn-primary btn-small" onclick="app.editPost(' + post.ID + ')">âœï¸ ç¼–è¾‘</button>' +
                            '<button class="btn btn-danger btn-small" onclick="app.deletePost(' + post.ID + ')">ğŸ—‘ï¸ åˆ é™¤</button>' +
                            '</div>';
                    }

                    return '<div class="post-card">' +
                        '<h3 onclick="app.viewPost(' + post.ID + ')">' + post.title + '</h3>' +
                        '<div class="post-meta">ğŸ‘¤ ' + (post.user ? post.user.username : 'æœªçŸ¥') + ' | ğŸ“… ' + new Date(post.CreatedAt).toLocaleString('zh-CN') + '</div>' +
                        '<div class="post-content">' + post.content.substring(0, 150) + (post.content.length > 150 ? '...' : '') + '</div>' +
                        actions +
                        '</div>';
                }).join('');
            },

            viewPost: function (id) {
                var self = this;
                fetch(this.apiBase + '/posts/' + id)
                    .then(function (res) { return res.json(); })
                    .then(function (data) {
                        if (data.code === 200) {
                            self.currentPost = data.data;
                            self.renderPostDetail(data.data);
                            self.fetchComments(id);

                            document.querySelectorAll('.page').forEach(function (p) {
                                p.classList.add('hidden');
                            });
                            document.getElementById('postDetailPage').classList.remove('hidden');
                        }
                    })
                    .catch(function (err) {
                        self.showAlert('error', 'è·å–æ–‡ç« è¯¦æƒ…å¤±è´¥');
                    });
            },

            renderPostDetail: function (post) {
                var container = document.getElementById('postDetail');
                container.innerHTML = '<div class="post-detail-header"><h2>' + post.title + '</h2>' +
                    '<div class="post-meta">ğŸ‘¤ ' + (post.user ? post.user.username : 'æœªçŸ¥') + ' | ğŸ“… ' + new Date(post.CreatedAt).toLocaleString('zh-CN') + '</div></div>' +
                    '<div class="post-content" style="line-height: 1.8; white-space: pre-wrap;">' + post.content + '</div>';

                var commentForm = document.getElementById('commentForm');
                if (this.token) {
                    commentForm.classList.remove('hidden');
                } else {
                    commentForm.classList.add('hidden');
                }
            },

            fetchComments: function (postId) {
                var self = this;
                fetch(this.apiBase + '/comments/post/' + postId)
                    .then(function (res) { return res.json(); })
                    .then(function (data) {
                        if (data.code === 200) {
                            self.renderComments(data.data || []);
                        }
                    })
                    .catch(function (err) {
                        console.error('Fetch comments error:', err);
                    });
            },

            renderComments: function (comments) {
                var container = document.getElementById('commentsList');

                if (!comments || comments.length === 0) {
                    container.innerHTML = '<p style="color: #8c8c8c; text-align: center;">æš‚æ— è¯„è®º,å¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§!</p>';
                    return;
                }

                container.innerHTML = comments.map(function (comment) {
                    return '<div class="comment-card">' +
                        '<div class="comment-meta">ğŸ‘¤ ' + (comment.user ? comment.user.username : 'æœªçŸ¥') + ' | ' + new Date(comment.CreatedAt).toLocaleString('zh-CN') + '</div>' +
                        '<div class="comment-content">' + comment.content + '</div>' +
                        '</div>';
                }).join('');
            },

            handleCreatePost: function () {
                var self = this;
                if (!this.token) {
                    this.showAlert('error', 'è¯·å…ˆç™»å½•');
                    return;
                }

                var title = document.getElementById('postTitle').value;
                var content = document.getElementById('postContent').value;

                fetch(this.apiBase + '/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.token
                    },
                    body: JSON.stringify({ title: title, content: content })
                })
                    .then(function (res) { return res.json(); })
                    .then(function (data) {
                        if (data.code === 200) {
                            self.showAlert('success', 'æ–‡ç« å‘å¸ƒæˆåŠŸ!');
                            document.getElementById('createPostForm').reset();
                            self.showPage('myPosts');
                        } else {
                            self.showAlert('error', data.message || 'å‘å¸ƒå¤±è´¥');
                        }
                    })
                    .catch(function (err) {
                        self.showAlert('error', 'å‘å¸ƒè¯·æ±‚å¤±è´¥');
                    });
            },

            editPost: function (id) {
                var self = this;
                fetch(this.apiBase + '/posts/' + id)
                    .then(function (res) { return res.json(); })
                    .then(function (data) {
                        if (data.code === 200) {
                            document.getElementById('editPostId').value = data.data.ID;
                            document.getElementById('editPostTitle').value = data.data.title;
                            document.getElementById('editPostContent').value = data.data.content;

                            document.querySelectorAll('.page').forEach(function (p) {
                                p.classList.add('hidden');
                            });
                            document.getElementById('editPostPage').classList.remove('hidden');
                        }
                    })
                    .catch(function (err) {
                        self.showAlert('error', 'è·å–æ–‡ç« ä¿¡æ¯å¤±è´¥');
                    });
            },

            handleUpdatePost: function () {
                var self = this;
                var id = document.getElementById('editPostId').value;
                var title = document.getElementById('editPostTitle').value;
                var content = document.getElementById('editPostContent').value;
                fetch(this.apiBase + '/posts/' + id, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.token
                    },
                    body: JSON.stringify({ title: title, content: content })
                })
                    .then(function (res) { return res.json(); })
                    .then(function (data) {
                        if (data.code === 200) {
                            self.showAlert('success', 'æ–‡ç« æ›´æ–°æˆåŠŸ!');
                            self.showPage('myPosts');
                        } else {
                            self.showAlert('error', data.message || 'æ›´æ–°å¤±è´¥');
                        }
                    })
                    .catch(function (err) {
                        self.showAlert('error', 'æ›´æ–°è¯·æ±‚å¤±è´¥');
                    });
            },

            deletePost: function (id) {
                var self = this;
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—?')) return;

                fetch(this.apiBase + '/posts/' + id, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + this.token }
                })
                    .then(function (res) { return res.json(); })
                    .then(function (data) {
                        if (data.code === 200) {
                            self.showAlert('success', 'æ–‡ç« åˆ é™¤æˆåŠŸ!');
                            self.fetchMyPosts();
                        } else {
                            self.showAlert('error', data.message || 'åˆ é™¤å¤±è´¥');
                        }
                    })
                    .catch(function (err) {
                        self.showAlert('error', 'åˆ é™¤è¯·æ±‚å¤±è´¥');
                    });
            },

            handleCreateComment: function () {
                var self = this;
                if (!this.token) {
                    this.showAlert('error', 'è¯·å…ˆç™»å½•');
                    return;
                }

                var content = document.getElementById('commentContent').value;
                var postId = this.currentPost.ID;

                fetch(this.apiBase + '/posts/' + postId + '/comments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.token
                    },
                    body: JSON.stringify({ content: content })
                })
                    .then(function (res) { return res.json(); })
                    .then(function (data) {
                        if (data.code === 200) {
                            self.showAlert('success', 'è¯„è®ºå‘è¡¨æˆåŠŸ!');
                            document.getElementById('commentContent').value = '';
                            self.fetchComments(postId);
                        } else {
                            self.showAlert('error', data.message || 'è¯„è®ºå¤±è´¥');
                        }
                    })
                    .catch(function (err) {
                        self.showAlert('error', 'è¯„è®ºè¯·æ±‚å¤±è´¥');
                    });
            },

            addTestResult: function (message, success) {
                var results = document.getElementById('testResults');
                var div = document.createElement('div');
                div.className = 'test-item test-' + (success ? 'success' : 'error');
                div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
                results.insertBefore(div, results.firstChild);
            },

            clearTestResults: function () {
                document.getElementById('testResults').innerHTML = '<p style="color: #8c8c8c;">æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>';
            },

            testHealth: function () {
                var self = this;
                this.addTestResult('å¼€å§‹å¥åº·æ£€æŸ¥æµ‹è¯•...', true);

                fetch('http://localhost:8080/health')
                    .then(function (res) {
                        if (res.ok) {
                            self.addTestResult('âœ” å¥åº·æ£€æŸ¥é€šè¿‡', true);
                        } else {
                            self.addTestResult('âœ— å¥åº·æ£€æŸ¥å¤±è´¥', false);
                        }
                    })
                    .catch(function (err) {
                        self.addTestResult('âœ— å¥åº·æ£€æŸ¥é”™è¯¯: ' + err.message, false);
                    });
            },

            testAuth: function () {
                var self = this;
                this.addTestResult('å¼€å§‹è®¤è¯æµ‹è¯•...', true);

                var testUser = {
                    username: 'test_' + Date.now(),
                    email: 'test_' + Date.now() + '@example.com',
                    password: 'test123456'
                };

                fetch(this.apiBase + '/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testUser)
                })
                    .then(function (res) { return res.json(); })
                    .then(function (regData) {
                        if (regData.code === 200) {
                            self.addTestResult('âœ” æ³¨å†Œæµ‹è¯•é€šè¿‡', true);

                            return fetch(self.apiBase + '/auth/login', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    username: testUser.username,
                                    password: testUser.password
                                })
                            });
                        } else {
                            self.addTestResult('âœ— æ³¨å†Œæµ‹è¯•å¤±è´¥', false);
                            throw new Error('Registration failed');
                        }
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (loginData) {
                        if (loginData.code === 200 && loginData.data.token) {
                            self.addTestResult('âœ” ç™»å½•æµ‹è¯•é€šè¿‡', true);

                            return fetch(self.apiBase + '/profile', {
                                headers: { 'Authorization': 'Bearer ' + loginData.data.token }
                            });
                        } else {
                            self.addTestResult('âœ— ç™»å½•æµ‹è¯•å¤±è´¥', false);
                            throw new Error('Login failed');
                        }
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (profileData) {
                        if (profileData.code === 200) {
                            self.addTestResult('âœ” è·å–ç”¨æˆ·ä¿¡æ¯æµ‹è¯•é€šè¿‡', true);
                        } else {
                            self.addTestResult('âœ— è·å–ç”¨æˆ·ä¿¡æ¯æµ‹è¯•å¤±è´¥', false);
                        }
                    })
                    .catch(function (err) {
                        self.addTestResult('âœ— è®¤è¯æµ‹è¯•é”™è¯¯: ' + err.message, false);
                    });
            },

            testPosts: function () {
                var self = this;
                if (!this.token) {
                    this.addTestResult('âœ— è¯·å…ˆç™»å½•åå†æµ‹è¯•æ–‡ç« åŠŸèƒ½', false);
                    return;
                }

                this.addTestResult('å¼€å§‹æ–‡ç« æµ‹è¯•...', true);

                var postData = {
                    title: 'æµ‹è¯•æ–‡ç«  ' + Date.now(),
                    content: 'è¿™æ˜¯ä¸€ç¯‡æµ‹è¯•æ–‡ç« çš„å†…å®¹'
                };

                var postId;

                fetch(this.apiBase + '/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.token
                    },
                    body: JSON.stringify(postData)
                })
                    .then(function (res) { return res.json(); })
                    .then(function (createData) {
                        if (createData.code === 200) {
                            self.addTestResult('âœ” åˆ›å»ºæ–‡ç« æµ‹è¯•é€šè¿‡', true);
                            postId = createData.data.ID;

                            return fetch(self.apiBase + '/posts/' + postId);
                        } else {
                            self.addTestResult('âœ— åˆ›å»ºæ–‡ç« æµ‹è¯•å¤±è´¥', false);
                            throw new Error('Create post failed');
                        }
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (getData) {
                        if (getData.code === 200) {
                            self.addTestResult('âœ” è·å–æ–‡ç« è¯¦æƒ…æµ‹è¯•é€šè¿‡', true);

                            return fetch(self.apiBase + '/posts/' + postId, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer ' + self.token
                                },
                                body: JSON.stringify({
                                    title: 'æ›´æ–°åçš„æ ‡é¢˜',
                                    content: 'æ›´æ–°åçš„å†…å®¹'
                                })
                            });
                        } else {
                            self.addTestResult('âœ— è·å–æ–‡ç« è¯¦æƒ…æµ‹è¯•å¤±è´¥', false);
                            throw new Error('Get post failed');
                        }
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (updateData) {
                        if (updateData.code === 200) {
                            self.addTestResult('âœ” æ›´æ–°æ–‡ç« æµ‹è¯•é€šè¿‡', true);

                            return fetch(self.apiBase + '/posts/' + postId, {
                                method: 'DELETE',
                                headers: { 'Authorization': 'Bearer ' + self.token }
                            });
                        } else {
                            self.addTestResult('âœ— æ›´æ–°æ–‡ç« æµ‹è¯•å¤±è´¥', false);
                            throw new Error('Update post failed');
                        }
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (deleteData) {
                        if (deleteData.code === 200) {
                            self.addTestResult('âœ” åˆ é™¤æ–‡ç« æµ‹è¯•é€šè¿‡', true);
                        } else {
                            self.addTestResult('âœ— åˆ é™¤æ–‡ç« æµ‹è¯•å¤±è´¥', false);
                        }

                        return fetch(self.apiBase + '/posts');
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (listData) {
                        if (listData.code === 200) {
                            self.addTestResult('âœ” è·å–æ–‡ç« åˆ—è¡¨æµ‹è¯•é€šè¿‡', true);
                        } else {
                            self.addTestResult('âœ— è·å–æ–‡ç« åˆ—è¡¨æµ‹è¯•å¤±è´¥', false);
                        }
                    })
                    .catch(function (err) {
                        self.addTestResult('âœ— æ–‡ç« æµ‹è¯•é”™è¯¯: ' + err.message, false);
                    });
            },

            testComments: function () {
                var self = this;
                if (!this.token) {
                    this.addTestResult('âœ— è¯·å…ˆç™»å½•åå†æµ‹è¯•è¯„è®ºåŠŸèƒ½', false);
                    return;
                }

                this.addTestResult('å¼€å§‹è¯„è®ºæµ‹è¯•...', true);

                var postId;

                fetch(this.apiBase + '/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.token
                    },
                    body: JSON.stringify({
                        title: 'æµ‹è¯•è¯„è®ºæ–‡ç« ',
                        content: 'ç”¨äºæµ‹è¯•è¯„è®ºåŠŸèƒ½'
                    })
                })
                    .then(function (res) { return res.json(); })
                    .then(function (postData) {
                        if (postData.code === 200) {
                            postId = postData.data.ID;

                            return fetch(self.apiBase + '/posts/' + postId + '/comments', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer ' + self.token
                                },
                                body: JSON.stringify({
                                    content: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯„è®º'
                                })
                            });
                        } else {
                            throw new Error('Create post for comments failed');
                        }
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (commentData) {
                        if (commentData.code === 200) {
                            self.addTestResult('âœ” åˆ›å»ºè¯„è®ºæµ‹è¯•é€šè¿‡', true);

                            return fetch(self.apiBase + '/comments/post/' + postId);
                        } else {
                            self.addTestResult('âœ— åˆ›å»ºè¯„è®ºæµ‹è¯•å¤±è´¥', false);
                            throw new Error('Create comment failed');
                        }
                    })
                    .then(function (res) { return res.json(); })
                    .then(function (getCommentsData) {
                        if (getCommentsData.code === 200) {
                            self.addTestResult('âœ” è·å–è¯„è®ºåˆ—è¡¨æµ‹è¯•é€šè¿‡', true);
                        } else {
                            self.addTestResult('âœ— è·å–è¯„è®ºåˆ—è¡¨æµ‹è¯•å¤±è´¥', false);
                        }

                        return fetch(self.apiBase + '/posts/' + postId, {
                            method: 'DELETE',
                            headers: { 'Authorization': 'Bearer ' + self.token }
                        });
                    })
                    .then(function () {
                        // Cleanup done
                    })
                    .catch(function (err) {
                        self.addTestResult('âœ— è¯„è®ºæµ‹è¯•é”™è¯¯: ' + err.message, false);
                    });
            },

            runAllTests: function () {
                var self = this;
                this.clearTestResults();
                this.addTestResult('=== å¼€å§‹è¿è¡Œå…¨éƒ¨æµ‹è¯• ===', true);

                this.testHealth();

                setTimeout(function () {
                    self.testAuth();
                }, 1000);

                setTimeout(function () {
                    self.testPosts();
                }, 2000);

                setTimeout(function () {
                    self.testComments();
                }, 3000);

                setTimeout(function () {
                    self.addTestResult('=== å…¨éƒ¨æµ‹è¯•å®Œæˆ ===', true);
                }, 5000);
            }
        };

        document.addEventListener('DOMContentLoaded', function () {
            app.init();
        });
    </script>
</body>

</html>